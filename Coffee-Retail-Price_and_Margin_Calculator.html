<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Retail Price Calculator</title>
    <style>
        /* ... (previous CSS remains largely the same) ... */
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap');

        :root {
            --red-orange: #EF4E37; --orange: #FF7F2F; --yellow: #FFB819;
            --light-green: #6CC04A; --medium-green: #009D4E; --dark-green: #006F42;
            --dark-gray: #555759; --light-gray: #F5F5F5; --border-color: #ddd;
            --background-light: #f9f9f9; --highlight-error: #EF4E37;
            --text-color: #555759; --label-width: 170px; /* Adjusted for tooltip icon */
            --body-font: 'DM Sans', sans-serif; --button-radius: 3px;
            --card-radius: 20px; --transition: all 0.3s ease; --card-gap: 2rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--body-font); line-height: 1.6; padding: 20px;
            background-color: var(--light-gray); color: var(--text-color);
            max-width: 1400px; margin: 20px auto;
        }
        h1 { text-align: center; color: var(--dark-green); margin-bottom: 25px; font-size: 2rem; }
        fieldset { border: none; padding: 0; margin-bottom: 30px; }
        legend {
            font-weight: 600; padding: 0 10px; color: var(--dark-green);
            font-size: 1.5rem; margin-bottom: 15px;
        }
        .top-section-wrapper {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: var(--card-gap); margin-bottom: var(--card-gap);
        }
        .container {
            background-color: white; border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 2rem;
        }
        body > .container { margin-bottom: var(--card-gap); }
        .instructions-card h2 { color: var(--dark-green); font-size: 1.5rem; margin-bottom: 15px; font-weight: 600; }
        .instructions-card p { margin-bottom: 10px; font-size: 0.95rem; }
        .instructions-card ul { margin-left: 20px; margin-bottom: 10px; }
        .instructions-card li { margin-bottom: 5px; font-size: 0.9rem; }
        .instructions-card ul ul { margin-top: 5px; margin-bottom: 5px; } /* Nested UL styling */

        .input-group { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group label {
            display: inline-flex; /* For aligning icon with text */
            align-items: center;
            width: var(--label-width); margin-right: 10px; font-size: 0.95rem;
            font-weight: 500; color: var(--dark-gray); flex-shrink: 0;
        }
        .input-group input[type="number"], .input-group .currency-symbol-display {
            padding: 10px; border: 1px solid var(--border-color);
            border-radius: var(--button-radius); font-size: 0.95rem;
            font-family: var(--body-font); transition: var(--transition);
        }
        .input-group input[type="number"] { width: 100px; }
        .input-group input[type="number"]:focus {
            border-color: var(--medium-green); outline: none;
            box-shadow: 0 0 0 2px rgba(0,157,78,0.2);
        }
        .input-group .currency-symbol-display {
            background-color: var(--background-light); border-left: none;
            border-radius: 0 var(--button-radius) var(--button-radius) 0;
            padding: 10px; margin-left: -1px; display: inline-block;
        }
        #greenCoffeeCost, #roastLabourCost, #packingCost, #otherVariableCost, #fxRate { width: 100px; }
        #targetGrossMargin, #roastShrinkage, #transactionFeePercent { width: 60px; }

        .currency-toggle { flex-wrap: nowrap !important; } /* Ensure radio buttons stay on one line */
        .currency-toggle label { margin-right: 15px; font-size: 0.95rem; cursor: pointer; width: auto !important; /* Override general label width */ }
        .currency-toggle input[type="radio"] { margin-right: 5px; vertical-align: middle; }

        table {
            width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem;
            border-radius: 8px; overflow: hidden; box-shadow: 0 0 0 1px var(--border-color);
        }
        th, td {
            border: 1px solid var(--border-color); padding: 12px 15px;
            text-align: left; vertical-align: middle;
        }
        th {
            background-color: var(--medium-green); color: white; font-weight: 500;
            white-space: nowrap; font-size: 0.9rem; position: relative; /* For tooltip context */
        }
        th .header-currency-symbol { margin-left: 3px; }
        td input[type="number"].cost-input, td input[type="number"].your-retail-price-input { width: 80px; }
        td input[type="number"].percent-input { width: 60px; }
        td input[type="number"] {
            padding: 8px; border: 1px solid var(--border-color);
            border-radius: var(--button-radius); text-align: right;
            font-family: var(--body-font); transition: var(--transition);
        }
        td input[type="number"]:focus {
            border-color: var(--medium-green); outline: none;
            box-shadow: 0 0 0 2px rgba(0,157,78,0.2);
        }
        td .output-currency-symbol {
            display: inline-block; margin-right: 5px; font-size: 0.9rem;
            min-width: 25px; text-align: right;
        }
        td[data-output] {
            text-align: right; font-family: var(--body-font); white-space: nowrap;
            background-color: #f9f9f9; font-weight: 500;
        }
        td[data-output] span[data-value] { display: inline-block; min-width: 50px; }
        td[data-output].percent-output span[data-value] { min-width: 40px; }
        .low-margin { color: var(--highlight-error); font-weight: bold; }
        .negative-margin { color: var(--highlight-error); font-weight: bold; }
        hr { border: none; border-top: 1px dashed var(--border-color); margin: 15px 0; }
        small {
            font-size: 0.8rem; color: #777;
            margin-left: calc(var(--label-width) + 10px); /* Aligns with input start */
            width: 100%; display: block; flex-basis: 100%;
        }
        tr:nth-child(even) { background-color: rgba(245,245,245,0.5); }
        tr:hover { background-color: rgba(108,192,74,0.05); }

        /* Tooltip Styles */
        .info-icon {
            display: inline-block;
            width: 16px; height: 16px;
            background-color: var(--medium-green);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            font-style: normal;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            position: relative; /* For tooltip positioning */
        }
        .info-icon .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--dark-gray);
            color: #fff;
            text-align: left;
            font-size: 0.85rem;
            font-weight: normal;
            line-height: 1.4;
            border-radius: 6px;
            padding: 8px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            margin-left: -110px; /* Half of width to center */
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .info-icon .tooltip-text::after { /* Arrow */
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark-gray) transparent transparent transparent;
        }
        .info-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        th .info-icon .tooltip-text {
            bottom: 100%;
            margin-bottom: 8px;
            white-space: normal;
        }

        #settingsManagerContainer .settings-btn { /* Targeted selector for buttons in this container */
            background-color: var(--medium-green); color: white; border: none;
            padding: 10px 15px; border-radius: var(--button-radius); cursor: pointer;
            font-family: var(--body-font); font-size: 0.9rem; margin-right: 10px;
            transition: background-color 0.2s ease;
        }
        #settingsManagerContainer .settings-btn:hover { background-color: var(--dark-green); }
        #settingsManagerContainer .settings-btn:last-child { margin-right: 0; }
        #settingsManagerContainer #resetSettingsBtn { background-color: var(--orange); }
        #settingsManagerContainer #resetSettingsBtn:hover { background-color: var(--red-orange); }
        #settingsMessage {
            display: block; /* Make it block to ensure it's on its own line under buttons */
            margin-top: 10px; font-size: 0.9em;
            color: var(--dark-green); font-weight: 500;
        }

        @media (max-width: 900px) {
            .top-section-wrapper { grid-template-columns: 1fr; }
            body { max-width: 1000px; }
            .top-section-wrapper > .container { margin-bottom: var(--card-gap); }
            body > *:last-child.container { margin-bottom: 0; }
            .top-section-wrapper > .container:last-child { margin-bottom: 0; }
        }
        @media (max-width: 768px) {
            :root { --label-width: 100%; } /* Label takes full width */
            body { padding: 15px; }
            .container { padding: 1.5rem; border-radius: 15px; }
            h1 { font-size: 1.5rem; }
            legend, .instructions-card h2 { font-size: 1.3rem; }
            .input-group { flex-direction: column; align-items: flex-start; }
            .input-group label { width: auto; margin-bottom: 5px; margin-right: 0; }
            .input-group input[type="number"] { width: 100%; }
            .currency-toggle label { margin-bottom: 5px; } /* Ensure spacing for wrapped radio labels */

            th, td { padding: 10px 8px; white-space: normal; }
            th { white-space: nowrap; }
            td input[type="number"].cost-input, td input[type="number"].your-retail-price-input { width: 75px; }
            td input[type="number"].percent-input { width: 60px; }
            td .output-currency-symbol { min-width: auto; margin-right: 2px; }
            td[data-output] span[data-value] { min-width: 45px; }
            td[data-output].percent-output span[data-value] { min-width: 35px; }
            table { font-size: 0.85rem; }
            small { margin-left: 0; }
            #settingsManagerContainer .settings-btn { margin-bottom: 10px; display: block; width: 100%; margin-right: 0;} /* Stack buttons */
            .info-icon { margin-left: 5px; }
             .info-icon .tooltip-text {
                width: 180px;
                margin-left: -90px;
            }
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <h1>Coffee Retail Price Calculator</h1>

    <div class="top-section-wrapper">
        <div class="container">
            <fieldset>
                <legend>Global Inputs</legend>

                <div class="input-group">
                    <label for="greenCoffeeCost">Green coffee cost: <i class="info-icon">i<span class="tooltip-text">Cost of raw green coffee beans per pound, including freight and financing.</span></i></label>
                    <input type="number" id="greenCoffeeCost" step="0.01" min="0" value="8.50">
                    <span class="currency-symbol-display per-unit" id="greenCoffeeCostUnit">$/lb</span>
                </div>

                <div class="input-group">
                    <label for="roastShrinkage">Roast Shrinkage: <i class="info-icon">i<span class="tooltip-text">Percentage weight loss during roasting (e.g., 15% means 1lb green yields 0.85lb roasted).</span></i></label>
                    <input type="number" id="roastShrinkage" step="0.1" min="0" max="99.9" value="15.0">
                    <span class="currency-symbol-display">%</span>
                </div>

                <div class="input-group">
                    <label for="roastLabourCost">Roast cost: <i class="info-icon">i<span class="tooltip-text">Cost to roast 1lb of coffee, including labor, utilities, and equipment amortization. Applied to *roasted* weight.</span></i></label>
                    <input type="number" id="roastLabourCost" step="0.01" min="0" value="1.28">
                    <span class="currency-symbol-display per-unit" id="roastLabourCostUnit">$/lb</span>
                    <small>(per lb of *roasted* coffee)</small>
                </div>

                <div class="input-group">
                    <label for="packingCost">Packing cost: <i class="info-icon">i<span class="tooltip-text">Cost for general packing materials (e.g., boxes, tape) and labor, per lb of *roasted* coffee. Bag/sticker costs are separate.</span></i></label>
                    <input type="number" id="packingCost" step="0.01" min="0" value="0.32">
                    <span class="currency-symbol-display per-unit" id="packingCostUnit">$/lb</span>
                    <small>(per lb of *roasted* coffee)</small>
                </div>

                <div class="input-group">
                    <label for="otherVariableCost">Other Variable Cost: <i class="info-icon">i<span class="tooltip-text">Any other per-unit costs not covered elsewhere (e.g., flyers, special handling). Applied per final retail unit/bag.</span></i></label>
                    <input type="number" id="otherVariableCost" step="0.01" min="0" value="0.00">
                    <span class="currency-symbol-display per-unit" id="otherVariableCostUnit">/unit</span>
                </div>

                <div class="input-group">
                    <label for="targetGrossMargin">Target Gross Margin: <i class="info-icon">i<span class="tooltip-text">Your desired profit margin (Retail Price - COGS) / Retail Price, before other operating expenses.</span></i></label>
                    <input type="number" id="targetGrossMargin" step="0.1" min="0" max="99.9" value="65">
                    <span class="currency-symbol-display">%</span>
                </div>

                <div class="input-group">
                    <label for="transactionFeePercent">Transaction Fee: <i class="info-icon">i<span class="tooltip-text">Percentage fee charged by payment processors (e.g., Stripe, Shopify Payments) on the retail price.</span></i></label>
                    <input type="number" id="transactionFeePercent" step="0.1" min="0" max="99.9" value="2.9">
                    <span class="currency-symbol-display">%</span>
                    <small>(e.g., payment processor fee, as % of retail price)</small>
                </div>

                <hr>

                <div class="input-group currency-toggle">
                    <label>Currency:</label>
                    <label><input type="radio" name="currency" value="CAD" checked> CAD</label>
                    <label><input type="radio" name="currency" value="USD"> USD</label>
                </div>

                <div class="input-group">
                    <label for="fxRate">Exchange rate: <i class="info-icon">i<span class="tooltip-text">If green coffee is priced in USD but you sell in CAD (or vice-versa), enter the rate. E.g., 1 USD = 1.39 CAD.</span></i></label>
                    <span>1 USD = </span>
                    <input type="number" id="fxRate" step="0.0001" min="0" value="1.39" style="margin: 0 5px; width: 80px;">
                    <span>CAD</span>
                </div>
            </fieldset>
        </div>

        <div class="container instructions-card">
             <h2>How to Use This Calculator</h2>
             <p>This tool helps determine suggested retail prices and analyze profit margins for your roasted coffee products.</p>
             <p><strong>Global Inputs:</strong></p>
             <ul>
                 <li>Enter costs like <strong>Green Coffee Cost</strong> (incl. freight/financing), <strong>Roast Shrinkage %</strong>, <strong>Roast Cost</strong> (labor, utilities per roasted lb), <strong>Packing Cost</strong> (general materials/labor per roasted lb), and any <strong>Other Variable Cost</strong> per retail unit (e.g., marketing inserts).</li>
                 <li>Set your <strong>Target Gross Margin %</strong> (profit before overheads/transport/fees) and typical <strong>Transaction Fee %</strong> (e.g., for online sales, applied to retail price).</li>
             </ul>
             <p><strong>Currency & FX:</strong> Select your selling currency. If green coffee is priced differently (e.g., USD cost, CAD selling), use the <strong>Exchange Rate</strong>. Changing currency auto-converts monetary inputs.</p>
             <p><strong>Tables Explained:</strong></p>
             <ul>
                <li><strong>Suggested Retail Pricing:</strong>
                    <ul>
                        <li>Adjust <strong>Bag Cost</strong> and <strong>Sticker Cost</strong> per specific retail size.</li>
                        <li><strong>Total Unit Cost (COGS):</strong> Sum of all direct costs for one unit (incl. "Other Variable Cost").</li>
                        <li><strong>Retail Price Needed:</strong> Calculated price to achieve your <em>Target Gross Margin</em>.</li>
                        <li><strong>Your Retail Price:</strong> Optionally, enter your own price here. If filled, calculations will use this price; otherwise, they use "Retail Price Needed".</li>
                        <li><strong>Achieved GM %:</strong> The actual Gross Margin based on the effective retail price and COGS.</li>
                    </ul>
                </li>
                <li><strong>Net DTC Margins (Direct-to-Consumer):</strong>
                    <ul>
                        <li>Enter <strong>Transportation %</strong> and <strong>Overhead %</strong> (both as % of retail price).</li>
                        <li><strong>Profit Per Unit:</strong> The absolute monetary profit for one DTC unit after all listed costs & fees.</li>
                        <li><strong>Achieved NM %:</strong> Net Margin after COGS, Transportation, Overhead, and Transaction Fees.</li>
                    </ul>
                </li>
                <li><strong>Net B2B Margins (Business-to-Business):</strong>
                    <ul>
                        <li>Enter <strong>Transportation %</strong>, <strong>Overhead %</strong>, and a <strong>Discount %</strong> (applied to the effective retail price).</li>
                        <li><strong>Profit Per Unit:</strong> The absolute monetary profit for one B2B unit.</li>
                        <li><strong>Achieved NM %:</strong> Net Margin for B2B sales.</li>
                    </ul>
                </li>
             </ul>
             <p>Calculations update live. Use <strong>Settings Management</strong> to save/load your inputs or reset to defaults.</p>
        </div>
    </div>

    <div class="container" id="settingsManagerContainer">
        <fieldset>
            <legend>Settings Management</legend>
            <div id="settingsManager">
                <button id="saveSettingsBtn" class="settings-btn">Save Current Settings</button>
                <button id="loadSettingsBtn" class="settings-btn">Load Saved Settings</button>
                <button id="resetSettingsBtn" class="settings-btn">Reset to Defaults</button>
            </div>
            <p id="settingsMessage"></p>
        </fieldset>
    </div>

    <div class="container">
        <fieldset>
            <legend>Suggested Retail Pricing</legend>
            <table>
                <thead>
                    <tr>
                        <th>Size</th>
                        <th>Bag cost (<span class="header-currency-symbol" id="headerBagCostCurrencySymbol">CAD</span>/unit)</th>
                        <th>Sticker cost (<span class="header-currency-symbol" id="headerStickerCostCurrencySymbol">CAD</span>/unit)</th>
                        <th>Total unit cost (<span class="header-currency-symbol" id="headerTotalCostCurrencySymbol">CAD</span>)</th>
                        <th>Retail price needed (<span class="header-currency-symbol" id="headerRetailPriceNeededCurrencySymbol">CAD</span>)</th>
                        <th>Your Retail Price (<span class="header-currency-symbol" id="headerYourRetailPriceCurrencySymbol">CAD</span>)</th>
                        <th>Achieved GM %</th>
                    </tr>
                </thead>
                <tbody id="grossMarginTableBody"></tbody>
            </table>
        </fieldset>
    </div>

    <div class="container">
        <fieldset>
            <legend>Net DTC Margins</legend>
            <table>
                <thead>
                    <tr>
                        <th>Size</th>
                        <th>Transportation % <i class="info-icon">i<span class="tooltip-text">Shipping/delivery costs as a percentage of the retail price for DTC sales.</span></i></th>
                        <th>Overhead % <i class="info-icon">i<span class="tooltip-text">General business overheads (rent, marketing, admin) allocated as a percentage of the retail price.</span></i></th>
                        <th>Total unit cost (<span class="header-currency-symbol" id="headerNmDTCTotalCostCurrencySymbol">CAD</span>)</th>
                        <th>Retail price (<span class="header-currency-symbol" id="headerNmDTCRetailPriceCurrencySymbol">CAD</span>)</th>
                        <th>Profit Per Unit (<span class="header-currency-symbol" id="headerNmDTCProfitUnitCurrencySymbol">CAD</span>)</th>
                        <th>Achieved NM %</th>
                    </tr>
                </thead>
                <tbody id="netDTCMarginTableBody"></tbody>
            </table>
        </fieldset>
    </div>

    <div class="container">
        <fieldset>
            <legend>Net B2B Margins</legend>
            <table>
                <thead>
                    <tr>
                        <th>Size</th>
                        <th>Transportation % <i class="info-icon">i<span class="tooltip-text">Shipping/delivery costs as a percentage of the (discounted) B2B selling price.</span></i></th>
                        <th>Overhead % <i class="info-icon">i<span class="tooltip-text">General business overheads allocated as a percentage of the (discounted) B2B selling price.</span></i></th>
                        <th>Total unit cost (<span class="header-currency-symbol" id="headerNmB2BTotalCostCurrencySymbol">CAD</span>)</th>
                        <th>Retail price (<span class="header-currency-symbol" id="headerNmB2BRetailPriceCurrencySymbol">CAD</span>)</th>
                        <th>Discount % <i class="info-icon">i<span class="tooltip-text">Discount offered to B2B customers, applied to the retail price.</span></i></th>
                        <th>Profit Per Unit (<span class="header-currency-symbol" id="headerNmB2BProfitUnitCurrencySymbol">CAD</span>)</th>
                        <th>Achieved NM %</th>
                    </tr>
                </thead>
                <tbody id="netB2BMarginTableBody"></tbody>
            </table>
        </fieldset>
    </div>

    <script>
        // --- Configuration ---
        const AppConfig = {
            LOCAL_STORAGE_KEY: 'coffeeCalculatorSettings_v2.1', // Incremented version for safety
            packSizes: [
                { key: '300g', name: '300 g', weightLb: 0.661387, defaultBagCost: 0.60, defaultStickerCost: 0.25, defaultYourRetailPrice: '', defaultDtcTranspoPercent: 18.0, defaultB2bTranspoPercent: 3.0, defaultOverheadPercent: 30.0, defaultB2BDiscountPercent: 40.0 },
                { key: '907g', name: '907 g', weightLb: 2.000, defaultBagCost: 0.79, defaultStickerCost: 0.12, defaultYourRetailPrice: '', defaultDtcTranspoPercent: 18.0, defaultB2bTranspoPercent: 3.0, defaultOverheadPercent: 30.0, defaultB2BDiscountPercent: 40.0 },
                { key: '2kg', name: '2.268 kg', weightLb: 5.000, defaultBagCost: 0.67, defaultStickerCost: 0.00, defaultYourRetailPrice: '', defaultDtcTranspoPercent: 18.0, defaultB2bTranspoPercent: 3.0, defaultOverheadPercent: 30.0, defaultB2BDiscountPercent: 40.0 },
                { key: '5kg', name: '5 kg', weightLb: 11.0231, defaultBagCost: 0.00, defaultStickerCost: 0.00, defaultYourRetailPrice: '', defaultDtcTranspoPercent: 18.0, defaultB2bTranspoPercent: 3.0, defaultOverheadPercent: 30.0, defaultB2BDiscountPercent: 40.0 }
            ],
            initialGlobalInputValues: {}
        };

        // --- DOM Elements Cache ---
        const DOMElements = {
            greenCoffeeCostInput: null, roastShrinkageInput: null, roastLabourCostInput: null,
            packingCostInput: null, otherVariableCostInput: null, targetGrossMarginInput: null,
            transactionFeePercentInput: null, currencyRadios: null, fxRateInput: null,
            grossMarginTableBody: null, netDTCMarginTableBody: null, netB2BMarginTableBody: null,
            saveSettingsBtn: null, loadSettingsBtn: null, resetSettingsBtn: null, settingsMessage: null,
            dynamicElements: {}
        };

        // --- Application State ---
        const AppState = {
            currentCurrency: 'CAD'
        };

        // --- Utility Functions ---
        const Utils = {
            formatMoney: (value) => (typeof value === 'number' && !isNaN(value)) ? value.toFixed(2) : '0.00',
            formatPercent: (value) => (typeof value === 'number' && !isNaN(value)) ? value.toFixed(1) : '0.0',
            sanitizeId: (text) => text.replace(/[\s.]+/g, '-'),
            parseFloatOrZero: (value) => parseFloat(value) || 0,
            createInput: (type, className, step, min, max, value, id, isMoney, placeholder = '') => {
                const input = document.createElement('input');
                input.type = type;
                input.className = className;
                if (step) input.step = step;
                if (min) input.min = min;
                if (max) input.max = max;
                input.value = value;
                input.id = id;
                if (placeholder) input.placeholder = placeholder;
                if (isMoney) input.dataset.moneyInput = 'true';
                input.addEventListener('input', UIEvents.handleInputChange);
                return input;
            },
            createOutputCell: (datasetName, currencySymbol = false, isPercentOutput = false) => {
                const cell = document.createElement('td');
                cell.dataset.output = datasetName;
                let currencySpan, valueSpan;
                if (currencySymbol) {
                    currencySpan = document.createElement('span');
                    currencySpan.className = 'output-currency-symbol';
                    cell.appendChild(currencySpan);
                }
                valueSpan = document.createElement('span');
                valueSpan.dataset.value = datasetName;
                cell.appendChild(valueSpan);
                if (isPercentOutput) {
                    cell.classList.add('percent-output');
                    const percentSymbolSpan = document.createElement('span');
                    percentSymbolSpan.textContent = '%';
                    cell.appendChild(percentSymbolSpan);
                }
                return { cell, currencySpan, valueSpan };
            }
        };

        // --- Settings Management Module ---
        const SettingsManager = {
            init() {
                DOMElements.saveSettingsBtn.addEventListener('click', this.save);
                DOMElements.loadSettingsBtn.addEventListener('click', this.load);
                DOMElements.resetSettingsBtn.addEventListener('click', () => this.reset(true)); // Ensure showMessage is true for button click
            },
            getGlobalInputValuesFromDOM() { // Renamed to be clear it reads from DOM
                return {
                    greenCoffeeCost: DOMElements.greenCoffeeCostInput.value,
                    roastShrinkage: DOMElements.roastShrinkageInput.value,
                    roastLabourCost: DOMElements.roastLabourCostInput.value,
                    packingCost: DOMElements.packingCostInput.value,
                    otherVariableCost: DOMElements.otherVariableCostInput.value,
                    targetGrossMargin: DOMElements.targetGrossMarginInput.value,
                    transactionFeePercent: DOMElements.transactionFeePercentInput.value,
                    currency: CurrencyHandler.getSelectedCurrency(),
                    fxRate: DOMElements.fxRateInput.value
                };
            },
            setInitialGlobalDefaults() { // New function to set AppConfig.initialGlobalInputValues
                 AppConfig.initialGlobalInputValues = this.getGlobalInputValuesFromDOM();
            },
            save() {
                const settings = {
                    global: SettingsManager.getGlobalInputValuesFromDOM(),
                    packSpecific: {}
                };
                AppConfig.packSizes.forEach(size => {
                    const sizeKey = size.key;
                    const els = DOMElements.dynamicElements[sizeKey];
                    if (!els) return;
                    settings.packSpecific[sizeKey] = {
                        bagCost: els.bagCostInput.value,
                        stickerCost: els.stickerCostInput.value,
                        yourRetailPrice: els.yourRetailPriceInput.value,
                        dtcTranspoPercent: els.dtcTransportationPercentInput.value,
                        dtcOverheadPercent: els.dtcOverheadPercentInput.value,
                        b2bTranspoPercent: els.b2bTransportationPercentInput.value,
                        b2bOverheadPercent: els.b2bOverheadPercentInput.value,
                        b2bDiscountPercent: els.b2bDiscountPercentInput.value,
                    };
                });
                localStorage.setItem(AppConfig.LOCAL_STORAGE_KEY, JSON.stringify(settings));
                DOMElements.settingsMessage.textContent = 'Settings saved!';
                setTimeout(() => DOMElements.settingsMessage.textContent = '', 3000);
            },
            load() {
                const savedSettingsJSON = localStorage.getItem(AppConfig.LOCAL_STORAGE_KEY);
                if (savedSettingsJSON) {
                    const savedSettings = JSON.parse(savedSettingsJSON);
                    Object.keys(savedSettings.global).forEach(key => {
                        const inputKey = key.endsWith('Input') ? key : key + 'Input'; // Attempt to form correct DOMElements key
                        if (key === 'currency') CurrencyHandler.setCurrency(savedSettings.global[key]);
                        // Check DOMElements for the key directly (e.g., fxRateInput) or with 'Input' suffix
                        else if (DOMElements[key]) DOMElements[key].value = savedSettings.global[key];
                        else if (DOMElements[inputKey]) DOMElements[inputKey].value = savedSettings.global[key];

                    });
                    AppConfig.packSizes.forEach(size => {
                        const sizeKey = size.key;
                        const savedPackData = savedSettings.packSpecific[sizeKey];
                        const els = DOMElements.dynamicElements[sizeKey];
                        if (savedPackData && els) {
                            Object.keys(savedPackData).forEach(packKey => {
                                const inputElementKey = packKey.endsWith('Input') ? packKey : packKey + 'Input';
                                if (els[inputElementKey]) {
                                   els[inputElementKey].value = savedPackData[packKey] || (packKey === 'yourRetailPrice' ? '' : '0');
                                }
                            });
                        }
                    });
                    DOMElements.settingsMessage.textContent = 'Settings loaded!';
                    setTimeout(() => DOMElements.settingsMessage.textContent = '', 3000);
                } else {
                    DOMElements.settingsMessage.textContent = 'No saved settings found. Using defaults.';
                    setTimeout(() => DOMElements.settingsMessage.textContent = '', 3000);
                    this.reset(false); // Reset to defaults if no saved data, but don't show "reset" message
                }
                Calculator.calculateAndDisplayAll();
            },
            reset(showMessage = true) {
                localStorage.removeItem(AppConfig.LOCAL_STORAGE_KEY);
                // Ensure initialGlobalInputValues is populated if not already
                if (Object.keys(AppConfig.initialGlobalInputValues).length === 0) {
                    this.setInitialGlobalDefaults();
                }

                Object.keys(AppConfig.initialGlobalInputValues).forEach(key => {
                    const inputKey = key.endsWith('Input') ? key : key + 'Input';
                    if (key === 'currency') CurrencyHandler.setCurrency(AppConfig.initialGlobalInputValues[key]);
                     else if (DOMElements[key]) DOMElements[key].value = AppConfig.initialGlobalInputValues[key]; // For fxRateInput
                    else if (DOMElements[inputKey]) DOMElements[inputKey].value = AppConfig.initialGlobalInputValues[key];
                });
                AppConfig.packSizes.forEach(size => {
                    const sizeKey = size.key;
                    const els = DOMElements.dynamicElements[sizeKey];
                    if (els) {
                        els.bagCostInput.value = Utils.formatMoney(size.defaultBagCost);
                        els.stickerCostInput.value = Utils.formatMoney(size.defaultStickerCost);
                        els.yourRetailPriceInput.value = size.defaultYourRetailPrice;
                        els.dtcTransportationPercentInput.value = Utils.formatPercent(size.defaultDtcTranspoPercent);
                        els.dtcOverheadPercentInput.value = Utils.formatPercent(size.defaultOverheadPercent);
                        els.b2bTransportationPercentInput.value = Utils.formatPercent(size.defaultB2bTranspoPercent);
                        els.b2bOverheadPercentInput.value = Utils.formatPercent(size.defaultOverheadPercent);
                        els.b2bDiscountPercentInput.value = Utils.formatPercent(size.defaultB2BDiscountPercent);
                    }
                });
                if (showMessage) {
                    DOMElements.settingsMessage.textContent = 'Settings reset to defaults.';
                    setTimeout(() => DOMElements.settingsMessage.textContent = '', 3000);
                }
                Calculator.calculateAndDisplayAll();
            }
        };

        // --- Currency Handling Module ---
        const CurrencyHandler = {
            init() {
                DOMElements.currencyRadios.forEach(radio => {
                    radio.addEventListener('change', this.handleCurrencyChange);
                });
                AppState.currentCurrency = this.getSelectedCurrency();
            },
            getSelectedCurrency() {
                const checkedRadio = document.querySelector('input[name="currency"]:checked');
                return checkedRadio ? checkedRadio.value : 'CAD';
            },
            setCurrency(currencyValue) {
                DOMElements.currencyRadios.forEach(radio => {
                    radio.checked = radio.value === currencyValue;
                });
                AppState.currentCurrency = currencyValue;
            },
            updateAllCurrencySymbols() {
                const currency = AppState.currentCurrency;
                document.getElementById('greenCoffeeCostUnit').textContent = `${currency}/lb`;
                document.getElementById('roastLabourCostUnit').textContent = `${currency}/lb`;
                document.getElementById('packingCostUnit').textContent = `${currency}/lb`;
                document.getElementById('otherVariableCostUnit').textContent = `${currency}/unit`;
                const headerSymbolIds = [
                    'headerBagCostCurrencySymbol', 'headerStickerCostCurrencySymbol', 'headerTotalCostCurrencySymbol',
                    'headerRetailPriceNeededCurrencySymbol', 'headerYourRetailPriceCurrencySymbol',
                    'headerNmDTCTotalCostCurrencySymbol', 'headerNmDTCRetailPriceCurrencySymbol', 'headerNmDTCProfitUnitCurrencySymbol',
                    'headerNmB2BTotalCostCurrencySymbol', 'headerNmB2BRetailPriceCurrencySymbol', 'headerNmB2BProfitUnitCurrencySymbol'
                ];
                headerSymbolIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = currency;
                });
                AppConfig.packSizes.forEach(size => {
                    const elements = DOMElements.dynamicElements[size.key];
                    if (elements) {
                        ['gmTotalCostCurrencySpan', 'gmRetailPriceNeededCurrencySpan',
                         'dtcTotalCostCurrencySpan', 'dtcRetailPriceCurrencySpan', 'dtcProfitPerUnitCurrencySpan',
                         'b2bTotalCostCurrencySpan', 'b2bRetailPriceCurrencySpan', 'b2bProfitPerUnitCurrencySpan'
                        ].forEach(spanKey => {
                            if (elements[spanKey]) elements[spanKey].textContent = currency;
                        });
                    }
                });
            },
            handleCurrencyChange() {
                const newCurrency = CurrencyHandler.getSelectedCurrency();
                if (newCurrency === AppState.currentCurrency) return;

                let fxRate = Utils.parseFloatOrZero(DOMElements.fxRateInput.value);
                if (fxRate <= 0) {
                    fxRate = 1.0;
                    DOMElements.fxRateInput.value = Utils.formatMoney(fxRate); // Use formatMoney for consistency, though rate might not always be 2 decimal
                }
                let conversionFactor = 1.0;
                if (AppState.currentCurrency === 'CAD' && newCurrency === 'USD') conversionFactor = 1 / fxRate;
                else if (AppState.currentCurrency === 'USD' && newCurrency === 'CAD') conversionFactor = fxRate;

                [DOMElements.greenCoffeeCostInput, DOMElements.roastLabourCostInput, DOMElements.packingCostInput, DOMElements.otherVariableCostInput]
                .forEach(input => {
                    if (input) { // Check if element exists
                        const currentValue = Utils.parseFloatOrZero(input.value);
                        input.value = Utils.formatMoney(currentValue * conversionFactor);
                    }
                });
                AppConfig.packSizes.forEach(size => {
                    const elements = DOMElements.dynamicElements[size.key];
                    if (elements) {
                        [elements.bagCostInput, elements.stickerCostInput, elements.yourRetailPriceInput].forEach(input => {
                            if (input && input.value.trim()) {
                                const currentValue = Utils.parseFloatOrZero(input.value);
                                input.value = Utils.formatMoney(currentValue * conversionFactor);
                            }
                        });
                    }
                });
                AppState.currentCurrency = newCurrency;
                Calculator.calculateAndDisplayAll();
            }
        };

        // --- UI Table Building Module ---
        const UITableBuilder = {
            init() {
                this.buildGrossMarginTable();
                this.buildNetDTCMarginTable();
                this.buildNetB2BMarginTable();
            },
            buildGrossMarginTable() {
                DOMElements.grossMarginTableBody.innerHTML = '';
                AppConfig.packSizes.forEach(size => {
                    const row = DOMElements.grossMarginTableBody.insertRow();
                    const sizeKey = size.key;
                    DOMElements.dynamicElements[sizeKey] = DOMElements.dynamicElements[sizeKey] || {};
                    const els = DOMElements.dynamicElements[sizeKey];

                    row.insertCell().textContent = size.name;
                    let cell = row.insertCell();
                    els.bagCostInput = Utils.createInput('number', 'cost-input', '0.01', '0', null, Utils.formatMoney(size.defaultBagCost), `bagCost-${Utils.sanitizeId(sizeKey)}`, true);
                    cell.appendChild(els.bagCostInput);
                    cell = row.insertCell();
                    els.stickerCostInput = Utils.createInput('number', 'cost-input', '0.01', '0', null, Utils.formatMoney(size.defaultStickerCost), `stickerCost-${Utils.sanitizeId(sizeKey)}`, true);
                    cell.appendChild(els.stickerCostInput);
                    const totalCost = Utils.createOutputCell('totalCost', true);
                    row.appendChild(totalCost.cell);
                    els.gmTotalCostValueSpan = totalCost.valueSpan;
                    els.gmTotalCostCurrencySpan = totalCost.currencySpan;
                    const retailNeeded = Utils.createOutputCell('retailPriceNeeded', true);
                    row.appendChild(retailNeeded.cell);
                    els.gmRetailPriceNeededValueSpan = retailNeeded.valueSpan;
                    els.gmRetailPriceNeededCurrencySpan = retailNeeded.currencySpan;
                    cell = row.insertCell();
                    els.yourRetailPriceInput = Utils.createInput('number', 'cost-input your-retail-price-input', '0.01', '0', null, size.defaultYourRetailPrice, `yourRetailPrice-${Utils.sanitizeId(sizeKey)}`, true, 'Auto');
                    cell.appendChild(els.yourRetailPriceInput);
                    const achievedGM = Utils.createOutputCell('achievedGM', false, true);
                    row.appendChild(achievedGM.cell);
                    els.gmAchievedPercentValueSpan = achievedGM.valueSpan;
                });
            },
            buildNetDTCMarginTable() {
                DOMElements.netDTCMarginTableBody.innerHTML = '';
                 AppConfig.packSizes.forEach(size => {
                    const row = DOMElements.netDTCMarginTableBody.insertRow();
                    const sizeKey = size.key;
                    DOMElements.dynamicElements[sizeKey] = DOMElements.dynamicElements[sizeKey] || {};
                    const els = DOMElements.dynamicElements[sizeKey];

                    row.insertCell().textContent = size.name;
                    let cell = row.insertCell();
                    els.dtcTransportationPercentInput = Utils.createInput('number', 'percent-input', '0.1', '0', null, Utils.formatPercent(size.defaultDtcTranspoPercent), `dtcTranspoPercent-${Utils.sanitizeId(sizeKey)}`, false);
                    cell.appendChild(els.dtcTransportationPercentInput);
                    cell.insertAdjacentHTML('beforeend', ' <span style="font-size:0.9em;">%</span>');
                    cell = row.insertCell();
                    els.dtcOverheadPercentInput = Utils.createInput('number', 'percent-input', '0.1', '0', null, Utils.formatPercent(size.defaultOverheadPercent), `dtcOverheadPercent-${Utils.sanitizeId(sizeKey)}`, false);
                    cell.appendChild(els.dtcOverheadPercentInput);
                    cell.insertAdjacentHTML('beforeend', ' <span style="font-size:0.9em;">%</span>');
                    const totalCost = Utils.createOutputCell('totalCost', true);
                    row.appendChild(totalCost.cell);
                    els.dtcTotalCostValueSpan = totalCost.valueSpan;
                    els.dtcTotalCostCurrencySpan = totalCost.currencySpan;
                    const retailPrice = Utils.createOutputCell('retailPrice', true);
                    row.appendChild(retailPrice.cell);
                    els.dtcRetailPriceValueSpan = retailPrice.valueSpan;
                    els.dtcRetailPriceCurrencySpan = retailPrice.currencySpan;
                    const profitUnit = Utils.createOutputCell('profitPerUnit', true);
                    row.appendChild(profitUnit.cell);
                    els.dtcProfitPerUnitValueSpan = profitUnit.valueSpan;
                    els.dtcProfitPerUnitCurrencySpan = profitUnit.currencySpan;
                    const achievedNM = Utils.createOutputCell('achievedNM', false, true);
                    row.appendChild(achievedNM.cell);
                    els.dtcAchievedPercentValueSpan = achievedNM.valueSpan;
                });
            },
            buildNetB2BMarginTable() {
                DOMElements.netB2BMarginTableBody.innerHTML = '';
                AppConfig.packSizes.forEach(size => {
                    const row = DOMElements.netB2BMarginTableBody.insertRow();
                    const sizeKey = size.key;
                    DOMElements.dynamicElements[sizeKey] = DOMElements.dynamicElements[sizeKey] || {};
                    const els = DOMElements.dynamicElements[sizeKey];

                    row.insertCell().textContent = size.name;
                    let cell = row.insertCell();
                    els.b2bTransportationPercentInput = Utils.createInput('number', 'percent-input', '0.1', '0', null, Utils.formatPercent(size.defaultB2bTranspoPercent), `b2bTranspoPercent-${Utils.sanitizeId(sizeKey)}`, false);
                    cell.appendChild(els.b2bTransportationPercentInput);
                    cell.insertAdjacentHTML('beforeend', ' <span style="font-size:0.9em;">%</span>');
                    cell = row.insertCell();
                    els.b2bOverheadPercentInput = Utils.createInput('number', 'percent-input', '0.1', '0', null, Utils.formatPercent(size.defaultOverheadPercent), `b2bOverheadPercent-${Utils.sanitizeId(sizeKey)}`, false);
                    cell.appendChild(els.b2bOverheadPercentInput);
                    cell.insertAdjacentHTML('beforeend', ' <span style="font-size:0.9em;">%</span>');
                    const totalCost = Utils.createOutputCell('totalCost', true);
                    row.appendChild(totalCost.cell);
                    els.b2bTotalCostValueSpan = totalCost.valueSpan;
                    els.b2bTotalCostCurrencySpan = totalCost.currencySpan;
                    const retailPrice = Utils.createOutputCell('retailPrice', true);
                    row.appendChild(retailPrice.cell);
                    els.b2bRetailPriceValueSpan = retailPrice.valueSpan;
                    els.b2bRetailPriceCurrencySpan = retailPrice.currencySpan;
                    cell = row.insertCell();
                    els.b2bDiscountPercentInput = Utils.createInput('number', 'percent-input', '0.1', '0', '99.9', Utils.formatPercent(size.defaultB2BDiscountPercent), `b2bDiscountPercent-${Utils.sanitizeId(sizeKey)}`, false);
                    cell.appendChild(els.b2bDiscountPercentInput);
                    cell.insertAdjacentHTML('beforeend', ' <span style="font-size:0.9em;">%</span>');
                    const profitUnit = Utils.createOutputCell('profitPerUnit', true);
                    row.appendChild(profitUnit.cell);
                    els.b2bProfitPerUnitValueSpan = profitUnit.valueSpan;
                    els.b2bProfitPerUnitCurrencySpan = profitUnit.currencySpan;
                    const achievedNM = Utils.createOutputCell('achievedNM', false, true);
                    row.appendChild(achievedNM.cell);
                    els.b2bAchievedPercentValueSpan = achievedNM.valueSpan;
                });
            }
        };

        // --- Core Calculation Logic ---
        const Calculator = {
            getInputs() { // Reads from DOMElements cache
                return {
                    greenCoffeeCost: Utils.parseFloatOrZero(DOMElements.greenCoffeeCostInput.value),
                    roastShrinkagePercent: Utils.parseFloatOrZero(DOMElements.roastShrinkageInput.value),
                    roastLabourCost: Utils.parseFloatOrZero(DOMElements.roastLabourCostInput.value),
                    packingCostPerLb: Utils.parseFloatOrZero(DOMElements.packingCostInput.value),
                    otherVariableCostPerUnit: Utils.parseFloatOrZero(DOMElements.otherVariableCostInput.value),
                    targetGrossMarginPercent: Utils.parseFloatOrZero(DOMElements.targetGrossMarginInput.value),
                    transactionFeePercent: Utils.parseFloatOrZero(DOMElements.transactionFeePercentInput.value)
                };
            },
            calculateAndDisplayAll() {
                const inputs = this.getInputs();
                CurrencyHandler.updateAllCurrencySymbols();

                let shrinkageFactor = 1 - (inputs.roastShrinkagePercent / 100);
                if (shrinkageFactor <= 0.0001) shrinkageFactor = 0.0001;
                const costPerRoastedLbEquivalent = inputs.greenCoffeeCost / shrinkageFactor;
                const totalMaterialCostPerRoastedLb = costPerRoastedLbEquivalent + inputs.roastLabourCost + inputs.packingCostPerLb;

                AppConfig.packSizes.forEach(size => {
                    const sizeKey = size.key;
                    const W_lb = size.weightLb;
                    const elements = DOMElements.dynamicElements[sizeKey];
                    if (!elements || !elements.bagCostInput) { /* Basic check */ console.error(`Elements for ${sizeKey} not fully initialized.`); return; }


                    const bagCost = Utils.parseFloatOrZero(elements.bagCostInput.value);
                    const stickerCost = Utils.parseFloatOrZero(elements.stickerCostInput.value);
                    const cogsPerUnit = (totalMaterialCostPerRoastedLb * W_lb) + bagCost + stickerCost + inputs.otherVariableCostPerUnit;
                    let retailPriceNeededForTargetGM = 0;
                    const targetGMDecimal = inputs.targetGrossMarginPercent / 100;
                    if (1 - targetGMDecimal > 0.0001) retailPriceNeededForTargetGM = cogsPerUnit / (1 - targetGMDecimal);
                    else retailPriceNeededForTargetGM = cogsPerUnit;

                    let effectiveRetailPrice = retailPriceNeededForTargetGM;
                    const yourRetailPriceStr = elements.yourRetailPriceInput.value;
                    if (yourRetailPriceStr && !isNaN(parseFloat(yourRetailPriceStr))) {
                        const yourRetailPriceNum = Utils.parseFloatOrZero(yourRetailPriceStr);
                        if (yourRetailPriceNum > 0) effectiveRetailPrice = yourRetailPriceNum;
                    }

                    let achievedGMPercent = 0;
                    if (effectiveRetailPrice > 0.0001) achievedGMPercent = ((effectiveRetailPrice - cogsPerUnit) / effectiveRetailPrice) * 100;
                    else if (cogsPerUnit <= 0) achievedGMPercent = 100;
                    else achievedGMPercent = -Infinity;

                    elements.gmTotalCostValueSpan.textContent = Utils.formatMoney(cogsPerUnit);
                    elements.gmRetailPriceNeededValueSpan.textContent = Utils.formatMoney(retailPriceNeededForTargetGM);
                    elements.gmAchievedPercentValueSpan.textContent = (achievedGMPercent === -Infinity) ? 'N/A' : Utils.formatPercent(achievedGMPercent);
                    elements.gmAchievedPercentValueSpan.classList.toggle('low-margin', achievedGMPercent !== -Infinity && achievedGMPercent < inputs.targetGrossMarginPercent - 0.01 && effectiveRetailPrice === retailPriceNeededForTargetGM);
                    elements.gmAchievedPercentValueSpan.classList.toggle('negative-margin', achievedGMPercent < 0);

                    const dtcTranspoPercent = Utils.parseFloatOrZero(elements.dtcTransportationPercentInput.value);
                    const dtcOverheadPercent = Utils.parseFloatOrZero(elements.dtcOverheadPercentInput.value);
                    const totalDTCVariablePercent = dtcTranspoPercent + dtcOverheadPercent + inputs.transactionFeePercent;
                    const dtcProfitPerUnit = effectiveRetailPrice - cogsPerUnit - (effectiveRetailPrice * (totalDTCVariablePercent / 100));
                    let dtcNetMarginPercent = 0;
                    if (effectiveRetailPrice > 0.0001) dtcNetMarginPercent = (dtcProfitPerUnit / effectiveRetailPrice) * 100;
                    else dtcNetMarginPercent = (cogsPerUnit > 0 || totalDTCVariablePercent > 0) ? -Infinity : 0;

                    elements.dtcTotalCostValueSpan.textContent = Utils.formatMoney(cogsPerUnit);
                    elements.dtcRetailPriceValueSpan.textContent = Utils.formatMoney(effectiveRetailPrice);
                    elements.dtcProfitPerUnitValueSpan.textContent = Utils.formatMoney(dtcProfitPerUnit);
                    elements.dtcAchievedPercentValueSpan.textContent = (dtcNetMarginPercent === -Infinity) ? 'N/A' : Utils.formatPercent(dtcNetMarginPercent);
                    elements.dtcAchievedPercentValueSpan.classList.toggle('negative-margin', dtcNetMarginPercent < 0 && dtcNetMarginPercent !== -Infinity);

                    const b2bTranspoPercent = Utils.parseFloatOrZero(elements.b2bTransportationPercentInput.value);
                    const b2bOverheadPercent = Utils.parseFloatOrZero(elements.b2bOverheadPercentInput.value);
                    const b2bDiscountPercent = Utils.parseFloatOrZero(elements.b2bDiscountPercentInput.value);
                    const b2bSellingPrice = effectiveRetailPrice * (1 - (b2bDiscountPercent / 100));
                    const totalB2BVariablePercent = b2bTranspoPercent + b2bOverheadPercent + inputs.transactionFeePercent;
                    const b2bProfitPerUnit = b2bSellingPrice - cogsPerUnit - (b2bSellingPrice * (totalB2BVariablePercent / 100));
                    let b2bNetMarginPercent = 0;
                    if (b2bSellingPrice > 0.0001) b2bNetMarginPercent = (b2bProfitPerUnit / b2bSellingPrice) * 100;
                    else b2bNetMarginPercent = (cogsPerUnit > 0 || totalB2BVariablePercent > 0) ? -Infinity : 0;

                    elements.b2bTotalCostValueSpan.textContent = Utils.formatMoney(cogsPerUnit);
                    elements.b2bRetailPriceValueSpan.textContent = Utils.formatMoney(effectiveRetailPrice);
                    elements.b2bProfitPerUnitValueSpan.textContent = Utils.formatMoney(b2bProfitPerUnit);
                    elements.b2bAchievedPercentValueSpan.textContent = (b2bNetMarginPercent === -Infinity || isNaN(b2bNetMarginPercent)) ? 'N/A' : Utils.formatPercent(b2bNetMarginPercent);
                    elements.b2bAchievedPercentValueSpan.classList.toggle('negative-margin', b2bNetMarginPercent < 0 && b2bNetMarginPercent !== -Infinity);
                });
            }
        };

        // --- UI Event Handlers ---
        const UIEvents = {
            init() {
                const globalInputsForEvents = [ // Use the DOMElements cache
                    DOMElements.greenCoffeeCostInput, DOMElements.roastShrinkageInput,
                    DOMElements.roastLabourCostInput, DOMElements.packingCostInput,
                    DOMElements.otherVariableCostInput, DOMElements.targetGrossMarginInput,
                    DOMElements.transactionFeePercentInput, DOMElements.fxRateInput
                ];
                globalInputsForEvents.forEach(input => {
                    if (input) input.addEventListener('input', this.handleInputChange);
                });
            },
            handleInputChange() {
                Calculator.calculateAndDisplayAll();
            }
        };

        // --- Application Initialization ---
        function initializeApp() {
            Object.keys(DOMElements).forEach(key => {
                if (key !== 'dynamicElements') {
                    const elementId = key.replace(/Input$/, '');
                    const elById = document.getElementById(key) || document.getElementById(elementId);
                    if (elById) {
                        DOMElements[key] = elById;
                    } else if (key === 'currencyRadios') { // Special case for radio nodelist
                        DOMElements[key] = document.querySelectorAll('input[name="currency"]');
                    }
                }
            });

            SettingsManager.setInitialGlobalDefaults(); // Set defaults from current DOM values
            UITableBuilder.init();
            CurrencyHandler.init();
            SettingsManager.init();
            UIEvents.init();

            SettingsManager.load(); // Load saved settings or reset to defaults, then calculate
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
